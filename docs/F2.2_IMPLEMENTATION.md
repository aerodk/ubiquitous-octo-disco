# F2.2 Implementation: Back Button Navigation Control

## Overview
This document describes the implementation of Feature F2.2, which controls back button navigation between rounds in the tournament.

## Requirements (Original Issue in Danish)
**Issue Title:** F2.2 Tilbage knap efter runde skal ikke returnere til forsiden

**Description:** 
- Når en runde er afviklet, skal tilbage knappen ikke gå tilbage til start siden med spillere, men tilbage til den forrige runde.

**Acceptance Criteria:**
1. Det skal kun være muligt at gå én runde tilbage
2. Du må kun gå én runde tilbage hvis der ikke er indtastet nogen score endnu

**Translation:**
- When a round is completed, the back button should NOT return to the setup page with players, but to the previous round
- It should only be possible to go back ONE round
- You may only go back one round if NO scores have been entered yet

## Implementation

### Architecture Changes

#### 1. Tournament State Management
**File:** `lib/screens/setup_screen.dart`

**Change:** Modified `_generateFirstRound()` to create a `Tournament` object containing the first round, instead of passing just the round.

```dart
// Before: Passed only the round
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => RoundDisplayScreen(round: firstRound),
  ),
);

// After: Pass tournament containing the round
final tournament = Tournament(
  name: Constants.getDefaultTournamentName(), // e.g., "Padel turnering 03-01-2026"
  players: _players,
  courts: courts,
  rounds: [firstRound],
);

Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => RoundDisplayScreen(tournament: tournament),
  ),
);
```

#### 2. Multi-Round Navigation
**File:** `lib/screens/round_display_screen.dart`

**Changes:**
1. Changed from `StatelessWidget` to `StatefulWidget` to manage tournament state
2. Changed constructor to accept `Tournament` instead of `Round`
3. Added `_currentRound` getter to access the current round from the tournament
4. Added `_canGoBack` getter to determine if back navigation is allowed
5. Added `_goToPreviousRound()` method to navigate to previous round
6. Added `_generateNextRound()` method to create and navigate to next round

**Key Logic:**

```dart
bool get _canGoBack {
  // Can only go back if:
  // 1. Not on the first round
  if (_tournament.rounds.length <= 1) return false;
  
  // 2. No scores entered in current round
  final currentRound = _currentRound;
  final hasAnyScores = currentRound.matches.any(
    (match) => match.team1Score != null || match.team2Score != null
  );
  
  return !hasAnyScores;
}
```

#### 3. Back Button Control
**File:** `lib/screens/round_display_screen.dart`

**Implementation:** Used `PopScope` widget to control both system and UI back button behavior:

```dart
PopScope(
  canPop: _canGoBack,  // Controls system back button (Android)
  onPopInvokedWithResult: (bool didPop, dynamic result) {
    if (!didPop && !_canGoBack) {
      // Show message when back is blocked
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('Du kan ikke gå tilbage når der er indtastet score'),
          backgroundColor: Colors.orange,
        ),
      );
    }
  },
  child: Scaffold(
    appBar: AppBar(
      // Custom back button for multi-round tournaments
      leading: _tournament.rounds.length > 1
          ? IconButton(
              icon: const Icon(Icons.arrow_back),
              onPressed: _canGoBack ? _goToPreviousRound : null,
            )
          : null,
    ),
    ...
  ),
)
```

#### 4. Score Entry UI
**File:** `lib/widgets/match_card.dart`

**Changes:**
1. Changed from `StatelessWidget` to `StatefulWidget`
2. Made the card tappable to open score input dialog
3. Added `ScoreInputDialog` for entering match scores
4. Added `onScoreChanged` callback to notify parent when scores change
5. Shows visual indicator (checkmark) when scores are entered

**Key Features:**
- Tap on any match card to enter scores
- Score dialog shows buttons 0-24 for each team
- Automatically calculates opposing team's score (24 - selected score)
- Visual feedback: checkmark icon when scores entered, edit icon otherwise
- Notifies parent screen to update back button state

#### 5. UI State Synchronization
**Problem:** When scores are entered in MatchCard, the parent RoundDisplayScreen needs to update its back button state.

**Solution:** Added callback mechanism:
```dart
// In MatchCard
final VoidCallback? onScoreChanged;

// When score saved
widget.onScoreChanged?.call();

// In RoundDisplayScreen
MatchCard(
  match: match,
  onScoreChanged: () => setState(() {}),  // Triggers rebuild
)
```

### Navigation Flow

#### Scenario 1: Moving Forward Through Rounds
```
SetupScreen 
  → [User clicks "Generer Første Runde"]
  → Navigator.push(RoundDisplayScreen with Round 1)
  → [User clicks "Generer Næste Runde"]
  → Navigator.push(RoundDisplayScreen with Round 1 + 2)
  → [User clicks "Generer Næste Runde"]
  → Navigator.push(RoundDisplayScreen with Round 1 + 2 + 3)
```

#### Scenario 2: Going Back Without Scores
```
Current: Round 3 (no scores entered)
  → [User clicks back button]
  → Navigator.pushReplacement(RoundDisplayScreen with Round 1 + 2)
  → Shows Round 2
```

#### Scenario 3: Attempting Back With Scores
```
Current: Round 3 (scores entered in any match)
  → [User clicks back button or system back]
  → Back button is disabled (onPressed: null)
  → PopScope prevents navigation (canPop: false)
  → Shows SnackBar: "Du kan ikke gå tilbage når der er indtastet score"
```

### Testing

**File:** `test/round_display_navigation_test.dart`

Created comprehensive widget tests covering:
1. ✅ Round number display
2. ✅ Next round button presence
3. ✅ Back button shown for multi-round tournaments
4. ✅ Back button enabled when no scores
5. ✅ Back button disabled when scores entered
6. ✅ No back button on first round
7. ✅ `_canGoBack` getter logic with various scenarios

### Edge Cases Handled

1. **First Round**: No back button shown in AppBar
2. **Partial Scores**: If ANY match has ANY score (even just team1Score), back is disabled
3. **System Back Button**: Controlled via PopScope to match AppBar back button behavior
4. **UI Update**: Parent screen rebuilds when scores change to update back button state
5. **Navigation Stack**: Using `pushReplacement` when going back prevents navigation stack buildup

### Limitations & Future Improvements

1. **Round Generation**: Currently uses simple random generation for "next round". Version 2.0 should implement Americano algorithm per specification.

2. **Score Persistence**: Scores are stored in memory only. Version 2.0 should add SharedPreferences or Hive persistence.

3. **Multiple Back Steps**: Implementation naturally limits to one step back. Going back removes current round from tournament, so you can only go back one at a time.

4. **Score Editing**: Once entered, scores can be edited by tapping the match card again. This doesn't violate the requirement since editing existing scores is allowed.

## Files Changed

1. `lib/screens/setup_screen.dart` - Create tournament on first round generation
2. `lib/screens/round_display_screen.dart` - Multi-round navigation and back button control
3. `lib/widgets/match_card.dart` - Score input UI and change notification
4. `test/round_display_navigation_test.dart` - Comprehensive navigation tests

## Acceptance Criteria Verification

✅ **Requirement 1**: "Det skal kun være muligt at gå én runde tilbage"
- Implementation: `_goToPreviousRound()` removes only the current round, limiting to one step back

✅ **Requirement 2**: "Du må kun gå én runde tilbage hvis der ikke er indtastet nogen score endnu"
- Implementation: `_canGoBack` checks if any match has any score and returns false if found

✅ **Requirement 3**: "Tilbage knappen skal ikke gå tilbage til start siden med spillere, men tilbage til den forrige runde"
- Implementation: Navigation stack maintains tournament with all previous rounds, back button navigates within this stack, not to SetupScreen
