# F2.1 Save Session - Implementation Summary

## Overview
This feature implements local session persistence for the Padel Tournament app, ensuring that user data (players, courts, rounds, scores) is saved automatically and restored when the app is reopened.

## Key Changes

### 1. PersistenceService (`lib/services/persistence_service.dart`)
A new service that handles all local storage operations using SharedPreferences:

- **`saveTournament(Tournament)`** - Saves complete tournament state
- **`loadTournament()`** - Restores tournament from storage
- **`clearTournament()`** - Removes saved tournament
- **`saveSetupState(players, courtCount)`** - Saves setup screen state
- **`loadSetupState()`** - Restores setup screen state
- **`clearSetupState()`** - Removes setup state

The service includes error handling for corrupted data and automatic cleanup.

### 2. SetupScreen Updates (`lib/screens/setup_screen.dart`)
Enhanced to automatically persist user input:

- **On initialization**: Loads previously saved players and court count
- **Auto-save triggers**: 
  - When a player is added
  - When a player is removed
  - When court count changes
- **Clear all feature**: Button to reset all players and courts
- **Loading state**: Shows spinner while loading saved data

### 3. Tournament Model Enhancement (`lib/models/tournament.dart`)
Added `copyWith()` method to enable immutable updates:

```dart
Tournament copyWith({
  String? id,
  String? name,
  List<Player>? players,
  List<Court>? courts,
  List<Round>? rounds,
  DateTime? createdAt,
})
```

### 4. RoundDisplayScreen Updates (`lib/screens/round_display_screen.dart`)
Now accepts a `Tournament` instead of just a `Round`:

- Displays the current round from the tournament
- **Reset tournament feature**: Button in AppBar to clear and start over
- Confirmation dialog before resetting
- Proper navigation back to SetupScreen after reset

### 5. Main App Updates (`lib/main.dart`)
New `AppInitializer` widget that:

- Checks for saved tournament on app start
- Routes to `RoundDisplayScreen` if tournament exists
- Routes to `SetupScreen` if no tournament exists
- Shows loading spinner during check

## User Flow

### First Time User
1. Opens app → sees SetupScreen
2. Adds players and sets court count (auto-saved)
3. Generates first round → Tournament created and saved
4. Views round display

### Returning User (with saved tournament)
1. Opens app → AppInitializer checks storage
2. Automatically navigates to RoundDisplayScreen
3. Can continue tournament or reset

### Returning User (with saved setup only)
1. Opens app → AppInitializer checks storage
2. Navigates to SetupScreen
3. Previously entered players and courts are restored
4. Can modify and continue

## Data Persistence Keys
- `current_tournament` - Full tournament JSON
- `setup_players` - Player list JSON (setup screen)
- `setup_courts` - Court count integer (setup screen)

## Testing
New test file: `test/persistence_service_test.dart`
- Save/load setup state
- Save/load tournament
- Clear operations
- Corrupted data handling
- Null/empty cases

Updated: `test/models_test.dart`
- Added test for Tournament.copyWith()

## Future Enhancements
When score input is implemented (F-005), the tournament should be saved:
- After each score is entered
- After each round is completed
- When generating new rounds

This will ensure complete session persistence throughout the tournament lifecycle.
