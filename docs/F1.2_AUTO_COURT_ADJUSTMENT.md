# F.1.2 - Automatic Court Adjustment Implementation

## Overview
Implementation of automatic court count adjustment feature as specified in issue F.1.2. The system now automatically adjusts the number of courts based on player count (1 court per 4 players) with visual feedback.

## Implementation Date
December 19, 2025

## Requirements Implemented
1. ✅ Automatic court count adjustment when players are added/removed
2. ✅ Manual court adjustment remains available (users can override)
3. ✅ Visual animation/highlight when courts are auto-adjusted

## Technical Details

### Core Logic
- **Formula**: `suggestedCourts = floor(playerCount / 4)` with minimum of 1
- **Implementation**: `playerCount ~/ 4` for integer division (floor)
- **Behavior**: Only adds courts when enough players to fill a full court (4 players)
- **Constraints**: Clamped between `Constants.minCourts` (1) and `Constants.maxCourts` (18)

### Key Methods Added
1. **`_calculateSuggestedCourtCount(int playerCount)`**
   - Calculates the suggested number of courts based on player count
   - Returns minimum of 1 court when no players are registered
   - Only adds courts when there are enough players to fill them (4 players per court)

2. **`_autoAdjustCourtCount()`**
   - Compares current court count with suggested count
   - Updates court count if different
   - Triggers animation when adjustment occurs
   - Returns boolean indicating if adjustment was made

### Animation System
- **AnimationController**: 600ms duration for smooth, noticeable effect
- **Visual Effect**: Pulsing highlight with primary theme color
- **Implementation**: `AnimatedBuilder` wrapping the court count section
- **Color Interpolation**: Fades in/out with opacity 0.2 at peak

### Integration Points
- `_addPlayer()`: Calls `_autoAdjustCourtCount()` after adding player
- `_removePlayer()`: Calls `_autoAdjustCourtCount()` after removing player
- Manual adjustment buttons: Still functional, override auto-adjustment until next player change

## Test Coverage

### Unit Tests (court_auto_adjustment_test.dart)
- ✅ Calculation for 0 players → 1 court
- ✅ Calculation for 1-7 players → 1 court
- ✅ Calculation for 8-11 players → 2 courts
- ✅ Calculation for 12-15 players → 3 courts
- ✅ Calculation for various player counts
- ✅ Boundary conditions (min/max courts)
- ✅ Edge cases (negative numbers, very large numbers)

### Widget Tests (widget_test.dart)
- ✅ Court count auto-adjusts when adding players (7→8 players triggers 1→2 courts)
- ✅ Court count auto-adjusts when removing players
- ✅ Manual adjustment still works and coexists with auto-adjustment
- ✅ Full user flow: add 12 players, verify 3 courts, remove players, verify adjustment

## Examples

### Automatic Adjustment on Add
```
0 players → 1 court (minimum)
1-7 players → 1 court (not enough for 2 full courts)
8 players → 2 courts (auto-adjustment triggered, animation plays)
9-11 players → 2 courts
12 players → 3 courts (auto-adjustment triggered, animation plays)
13-15 players → 3 courts
24 players → 6 courts
```

### Automatic Adjustment on Remove
```
12 players (3 courts) → Remove 1 player → 11 players (2 courts, animation plays)
8 players (2 courts) → Remove 1 player → 7 players (1 court, animation plays)
```

### Manual Override
```
4 players (auto: 1 court) → User manually sets 3 courts
Add 4 more players (8 total) → Auto-adjusts to 2 courts (overrides manual setting)
User manually sets 4 courts → Remains 4 courts until player count changes
```

## User Experience

### Visual Feedback
When auto-adjustment occurs:
1. Court count changes immediately
2. A pulsing highlight effect appears around the court count section
3. Effect lasts 600ms (0.6 seconds)
4. Primary theme color with 20% opacity at peak

### Behavior
- **Non-intrusive**: Animation is subtle but noticeable
- **Informative**: Users can see when system makes automatic adjustments
- **Flexible**: Manual adjustments still available for special cases

## Code Quality
- ✅ Follows Flutter best practices
- ✅ Uses `SingleTickerProviderStateMixin` for animation
- ✅ Properly disposes animation controller
- ✅ Includes comprehensive comments
- ✅ Maintains existing code style and patterns
- ✅ No breaking changes to existing functionality

## Files Modified
1. `lib/screens/setup_screen.dart`
   - Added animation controller and state variables
   - Added calculation and auto-adjustment methods
   - Integrated auto-adjustment into add/remove player flows
   - Added animated highlight effect to UI

2. `test/widget_test.dart`
   - Added 3 new widget tests for auto-adjustment behavior
   - Tests cover add/remove scenarios and manual override

3. `test/court_auto_adjustment_test.dart` (NEW)
   - Unit tests for calculation logic
   - Comprehensive edge case coverage

## Future Considerations
- Animation style could be customized (duration, color, style)
- Could add user preference to disable auto-adjustment
- Could show a tooltip/snackbar explaining why courts changed
- Could add sound effect for accessibility

## Related Issues
- Issue F.1.2: Adjust number of lanes automatically
- Specification: F-002 (Bane Registration)
