# Bug Fixes for F2.2 - December 19, 2024

## Issues Reported by @aerodk

### Issue 1: Cannot go back from Round 1
**Problem**: User reported "Man kan ikke gå tilbage, i første runde, selv når ingen score er indtastet" (Cannot go back in first round even when no score is entered)

**Root Cause**: The `_canGoBack` getter had this logic:
```dart
if (_tournament.rounds.length <= 1) return false;
```
This prevented any back navigation from Round 1, even to the Setup screen.

**Fix**: Removed the round number check. Now `_canGoBack` only checks if scores are entered:
```dart
bool get _canGoBack {
  final hasAnyScores = currentRound.matches.any(
    (match) => match.team1Score != null || match.team2Score != null
  );
  return !hasAnyScores;
}
```

**New Behavior**:
- Round 1, no scores → Can go back to Setup screen ✓
- Round 1, with scores → Cannot go back ✓
- Round 2+, no scores → Can go back to previous round ✓
- Round 2+, with scores → Cannot go back ✓

### Issue 2: Score not displaying after save
**Problem**: User reported "Scoren gemmes ikke korrekt når man trykker 'Gem score'. Den vises ikke på oversigten med baner efterfølgende." (Score is not saved correctly when clicking 'Save score'. It's not displayed on the court overview afterwards)

**Initial Fix (91d470f)**: Added `ValueKey(match.id)` to MatchCard widgets to help Flutter identify each card uniquely.

**Actual Root Cause (discovered in further testing)**: Dart type mismatch in dialog result handling. The showDialog returns `Map<String, int?>` (with nullable int values) but the code was checking for `Map<String, int>` (non-nullable), causing the type check to always fail:

```dart
// BEFORE (incorrect - type check always failed)
if (result != null && result is Map<String, int>) {
  setState(() {
    widget.match.team1Score = result['team1Score'];
    widget.match.team2Score = result['team2Score'];
  });
}
```

This meant the scores were never saved to the Match object, which is why they didn't appear on the court overview or persist when reopening the dialog.

**Final Fix (5787805)**:
```dart
// AFTER (correct - handles nullable types properly)
if (result != null && result is Map && mounted) {
  final team1 = result['team1Score'] as int?;
  final team2 = result['team2Score'] as int?;
  if (team1 != null && team2 != null) {
    setState(() {
      widget.match.team1Score = team1;
      widget.match.team2Score = team2;
    });
    widget.onScoreChanged?.call();
  }
}
```

**Changes**:
- Changed type check from `is Map<String, int>` to `is Map`
- Added explicit null checks for score values
- Added mounted check to prevent setState on disposed widget

**Benefit**: Scores now save correctly and display immediately on the court overview.

## Code Changes

### File: `lib/screens/round_display_screen.dart`

**Change 1**: Updated `_canGoBack` getter (lines 31-40)
- Removed round number check
- Now only checks for score entry

**Change 2**: Updated `_goToPreviousRound()` method (lines 76-100)
- Added special handling for Round 1
- Uses `Navigator.pop()` for Round 1
- Uses `Navigator.pushReplacement()` for Round 2+

**Change 3**: Added ValueKey to MatchCard (line 197)
- Ensures proper widget identity for Flutter's reconciliation

### File: `lib/widgets/match_card.dart`

**Change 1**: Fixed dialog result type checking (lines 21-32)
- Changed from `is Map<String, int>` to `is Map`
- Added explicit null checks for score values
- Added mounted check for safety
- This was the critical fix that resolved the score display issue

## Testing

### Manual Testing Required
1. ✓ Start tournament and go to Round 1
2. ✓ Press back button → Should return to Setup screen
3. ✓ Go to Round 1, enter score in any match
4. ✓ Press back button → Should be blocked with message
5. ✓ Go to Round 2 without scores
6. ✓ Press back button → Should return to Round 1
7. ✓ Enter score in Round 1, then generate Round 2
8. ✓ Verify scores still visible in Round 1 (navigate back to check)
9. ✓ In any round, enter score and verify it displays immediately

### Automated Tests
- Existing tests still pass
- Tests verify UI behavior (AppBar leading button presence)
- No changes needed to tests as UI behavior is correct

## Commit History
- Hash: `91d470f` - Fix back navigation from Round 1 and add match key for proper widget identity
- Hash: `77c93ab` - Add bug fix documentation for F2.2
- Hash: `c4d3b87` - Improve code comments for clarity
- Hash: `5787805` - Fix score display issue - correct type check for dialog result (CRITICAL FIX)

## Resolution Status
- ✅ Issue 1 (back navigation) - FIXED in 91d470f
- ✅ Issue 2 (score display) - FIXED in 5787805
