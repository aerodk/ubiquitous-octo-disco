# Bug Fixes for F2.2 - December 19, 2024

## Issues Reported by @aerodk

### Issue 1: Cannot go back from Round 1
**Problem**: User reported "Man kan ikke gå tilbage, i første runde, selv når ingen score er indtastet" (Cannot go back in first round even when no score is entered)

**Root Cause**: The `_canGoBack` getter had this logic:
```dart
if (_tournament.rounds.length <= 1) return false;
```
This prevented any back navigation from Round 1, even to the Setup screen.

**Fix**: Removed the round number check. Now `_canGoBack` only checks if scores are entered:
```dart
bool get _canGoBack {
  final hasAnyScores = currentRound.matches.any(
    (match) => match.team1Score != null || match.team2Score != null
  );
  return !hasAnyScores;
}
```

**New Behavior**:
- Round 1, no scores → Can go back to Setup screen ✓
- Round 1, with scores → Cannot go back ✓
- Round 2+, no scores → Can go back to previous round ✓
- Round 2+, with scores → Cannot go back ✓

### Issue 2: Score not displaying after save
**Problem**: User reported "Scoren gemmes ikke korrekt når man trykker 'Gem score'. Den vises ikke på oversigten med baner efterfølgende." (Score is not saved correctly when clicking 'Save score'. It's not displayed on the court overview afterwards)

**Suspected Cause**: Flutter widget identity issue. When the parent RoundDisplayScreen rebuilds after a score change, it recreates the MatchCard widgets. Without proper keys, Flutter may not correctly preserve or update the widget tree.

**Fix**: Added `ValueKey(match.id)` to MatchCard widgets:
```dart
..._currentRound.matches.map(
  (match) => MatchCard(
    key: ValueKey(match.id),  // <-- Added this
    match: match,
    onScoreChanged: () => setState(() {}),
  ),
),
```

**Benefit**: The ValueKey helps Flutter identify each MatchCard uniquely by its match ID, ensuring proper widget state preservation and updates across rebuilds.

## Code Changes

### File: `lib/screens/round_display_screen.dart`

**Change 1**: Updated `_canGoBack` getter (lines 31-41)
- Removed round number check
- Now only checks for score entry

**Change 2**: Updated `_goToPreviousRound()` method (lines 76-100)
- Added special handling for Round 1
- Uses `Navigator.pop()` for Round 1
- Uses `Navigator.pushReplacement()` for Round 2+

**Change 3**: Added ValueKey to MatchCard (line 197)
- Ensures proper widget identity for Flutter's reconciliation

## Testing

### Manual Testing Required
1. ✓ Start tournament and go to Round 1
2. ✓ Press back button → Should return to Setup screen
3. ✓ Go to Round 1, enter score in any match
4. ✓ Press back button → Should be blocked with message
5. ✓ Go to Round 2 without scores
6. ✓ Press back button → Should return to Round 1
7. ✓ Enter score in Round 1, then generate Round 2
8. ✓ Verify scores still visible in Round 1 (navigate back to check)
9. ✓ In any round, enter score and verify it displays immediately

### Automated Tests
- Existing tests still pass
- Tests verify UI behavior (AppBar leading button presence)
- No changes needed to tests as UI behavior is correct

## Commit
- Hash: `91d470f`
- Message: "Fix back navigation from Round 1 and add match key for proper widget identity"

## Resolution Status
- ✅ Issue 1 (back navigation) - FIXED
- ⏳ Issue 2 (score display) - FIX APPLIED, needs user verification
