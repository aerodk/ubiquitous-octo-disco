# F2.2 Feature Summary - Back Button Navigation

## Issue (Original in Danish)
**F2.2 Tilbage knap efter runde skal ikke returnere til forsiden**

Når en runde er afviklet, skal tilbage knappen ikke gå tilbage til start siden med spillere, men tilbage til den forrige runde.

**Acceptance Criteria:**
1. Det skal kun være muligt at gå én runde tilbage
2. Du må kun gå én runde tilbage hvis der ikke er indtastet nogen score endnu

## What Was Built

### Visual Flow

#### BEFORE (Original Behavior)
```
SetupScreen
    ↓ [Generate First Round]
RoundDisplayScreen (Round 1)
    ↓ [Back Button]
SetupScreen ❌ (Wrong - goes back to setup)
```

#### AFTER (New Behavior)
```
SetupScreen
    ↓ [Generate First Round]
RoundDisplayScreen (Round 1)
    ↓ [Generate Next Round]
RoundDisplayScreen (Round 2)
    ↓ [Generate Next Round]
RoundDisplayScreen (Round 3)
    ↓ [Back Button - No Scores]
RoundDisplayScreen (Round 2) ✅ (Correct - goes to previous round)
    ↓ [Back Button - No Scores]
RoundDisplayScreen (Round 1) ✅
    ↓ [Back Button - Disabled on first round]
(Cannot go back further)
```

#### With Scores Entered
```
RoundDisplayScreen (Round 3)
    ↓ [User enters score in any match]
    ↓ [Back Button - Disabled]
    ↓ [System Back - Blocked]
SnackBar: "Du kan ikke gå tilbage når der er indtastet score" ❌
```

### Key Components

#### 1. Tournament State Management
- **Before**: Only single Round passed to RoundDisplayScreen
- **After**: Complete Tournament with array of Rounds passed through navigation
- **Benefit**: Maintains full history of all rounds

#### 2. Back Button Control Logic
```dart
bool get _canGoBack {
  // Rule 1: Must have at least 2 rounds
  if (_tournament.rounds.length <= 1) return false;
  
  // Rule 2: Current round must have NO scores
  final hasAnyScores = _currentRound.matches.any(
    (match) => match.team1Score != null || match.team2Score != null
  );
  
  return !hasAnyScores;
}
```

#### 3. Navigation Controls
- **PopScope**: Controls Android system back button
- **AppBar IconButton**: Custom back button in app bar
- **Both**: Disabled when scores entered, show feedback message

#### 4. Score Entry UI
- Tap any match card to open score dialog
- Select score 0-24 for one team
- Auto-calculate other team: `24 - selected_score`
- Visual indicators: ✓ checkmark (scored) or ✏️ edit icon (not scored)
- Callback notifies parent to update back button state

### User Experience

#### Scenario 1: Moving Forward Through Tournament
1. User sets up players and courts
2. Clicks "Generer Første Runde" → Shows Round 1
3. Clicks "Generer Næste Runde (2)" → Shows Round 2
4. Clicks "Generer Næste Runde (3)" → Shows Round 3
5. Back button is enabled (no scores entered)

#### Scenario 2: Going Back Without Scores
1. User is on Round 3 (no scores)
2. Clicks back button
3. App shows Round 2
4. Back button still enabled (no scores)
5. Clicks back button again
6. App shows Round 1
7. Back button disappears (first round)

#### Scenario 3: Trying to Go Back With Scores
1. User is on Round 3
2. Taps a match card
3. Enters score: Team 1 = 15, Team 2 = 9
4. Saves score
5. Back button becomes disabled (greyed out)
6. If user presses device back button (Android)
7. SnackBar appears: "Du kan ikke gå tilbage når der er indtastet score"
8. Stays on Round 3

### Technical Implementation

#### Files Modified
1. **SetupScreen** (`lib/screens/setup_screen.dart`)
   - Creates Tournament object with first round
   - Passes tournament to RoundDisplayScreen

2. **RoundDisplayScreen** (`lib/screens/round_display_screen.dart`)
   - Changed from StatelessWidget to StatefulWidget
   - Accepts Tournament instead of Round
   - Manages multi-round navigation
   - Implements back button control logic
   - Shows current round from tournament

3. **MatchCard** (`lib/widgets/match_card.dart`)
   - Changed from StatelessWidget to StatefulWidget
   - Added tap to open score dialog
   - Created ScoreInputDialog with score buttons
   - Added onScoreChanged callback
   - Visual feedback for scored matches

4. **Tests** (`test/round_display_navigation_test.dart`)
   - 8 comprehensive test cases
   - Tests all navigation scenarios
   - Verifies back button state
   - Tests with/without scores

5. **Documentation** (`docs/F2.2_IMPLEMENTATION.md`)
   - Complete architecture documentation
   - Flow diagrams
   - Edge cases
   - Acceptance criteria verification

### Edge Cases Handled

1. **First Round**: Back button not shown
2. **Partial Scores**: Even one score disables back button
3. **Multiple Matches**: If ANY match has scores, back disabled
4. **UI Synchronization**: Parent updates when scores change
5. **System vs UI Back**: Both behave identically
6. **Navigation Stack**: Uses pushReplacement to avoid buildup

### Testing Coverage

✅ Round number display
✅ Next round button functionality
✅ Back button visibility (first vs later rounds)
✅ Back button enabled when no scores
✅ Back button disabled when scores entered
✅ Back button disabled with partial scores (only team1Score)
✅ Multiple round navigation
✅ PopScope behavior

### Acceptance Criteria Status

| Criterion | Status | Implementation |
|-----------|--------|---------------|
| Can only go back ONE round | ✅ PASS | `_goToPreviousRound()` removes only current round |
| Can only go back if NO scores | ✅ PASS | `_canGoBack` checks for any scores in current round |
| Back goes to previous round, not setup | ✅ PASS | Tournament maintains full round history |

## Result

✅ **Feature F2.2 is complete and working as specified**

The back button now:
- Goes to previous round (not setup screen)
- Only allows one round back at a time
- Only works when no scores entered
- Provides clear feedback when blocked

Ready for manual testing and user acceptance.
